(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):n(jQuery)})(function(n){"use strict";function t(n){if(n===undefined||n.length===0||n.indexOf("?")===-1)return{};var i=n.split("?")[1].split("&"),t={};return i.forEach(function(n){var i=n.split("=");t[i[0]]=i[1]}),t}function r(n){return encodeURIComponent(i(n||"")).replace(/\%3F/ig,"~").replace(/\./ig,"^")}function i(n){return decodeURIComponent((n||"").replace(/\~/ig,"%3F").replace(/\^/ig,"."))}var u=function(t,i){return this.options=n.extend({},u.prototype.__options,i),this.$el=n(t),this.init.call(this,t)};return u.prototype={__options:{searchUrl:"",entryUrl:"",initEntry:null,maxDepth:-1,showSearch:!1,searchLimit:25,searchSelectEntry:"",showTitle:!0,showToc:!1,urlBase:"/portal/",faqPath:"faq/",infoPath:"info/"},renderSearch:function(r){var u=this,s=n("<select>",{"class":"cat"}),e=n("<select>",{"class":"subcat"}),o={},f;r=r!==undefined?r:!1;u.load(u.options.searchSelectEntry,function(i){var h=i.children("ul").children("li"),f;h.each(function(i,r){var f=n(r),e=f.children("a").first(),h=t(e.attr("href")),u;s.append(n("<option>",{value:h.page,text:e.text()}));u=n();f.children("ul").children("li").each(function(i,r){var e=n(r),f=e.children("a").first(),o=t(f.attr("href"));u=u.add(n("<option>",{value:o.page,text:f.text()}))});o[h.page]=u});f=o[t(h.first().children("a").first().attr("href")).page];e.append(f);r&&u.load(f.first().val())});f=n("<div>",{"class":"faqHeader"});f.append(n("<div>",{"class":"inner"}).append(n("<div>",{"class":"selectArea"}).append(s).append(e)).append(n("<div>",{"class":"searchArea"}).append(n("<label>",{"for":"searchInput",text:""})).append(n('<input placeholder="Suchbegriff eingeben">',{id:"searchInput",type:"text"})))).append(n("<button>",{type:"button",text:"Suche"})).append(n("<div>",{"class":"clear"}));f.on("keydown","input",function(t){var i=t.keyCode||t.which;i===13&&(t.preventDefault(),t.stopPropagation(),n(t.delegateTarget).children("button").trigger("click"))});f.on("click","button",function(t){t.preventDefault();t.stopPropagation();var i=n(t.delegateTarget).find(".searchArea input").val().trim();i.length<2||u.search.call(u,i)});f.on("change","select",function(t){var r=n(t.currentTarget),h=i(r.val()),f,s;r.hasClass("cat")?(f=o[h],s=f.first().val(),e.empty().append(f).val(s),u.load(s)):r.hasClass("subcat")&&u.load(h)});f.prependTo(this.$el)},render:function(u,f,e,o){var s=this,l,a,h,c;return(f=f!==undefined?f:!1,e=e!==undefined?e:0,u.find("a").each(function(i,r){var u=t(r.href);u.redlink!==undefined&&u.redlink==="1"&&n(r).replaceWith(function(t,i){return n("<span>",{html:i,"class":"redlink"})})}),u.children().filter(":not(#rating)").length===0)?n("<h3>",{"class":"pageNotFound",text:"Die angegebene Seite konnte nicht gefunden werden."}):(s.options.showToc===!0?u.find("table.toc").replaceWith(function(t,i){var r=n(i),u=r.find("#toctitle");return r.find("ul").reverse().replaceWith(function(t,i){var u=n(i).not("text"),r=n();return u.each(function(t,i){var u=n(i),f=u.find(".toc-content"),o=n("<span>",{"class":"faq-toc-link",text:u.find(".toctext").text()}),e=n("<div>",{"class":"toc-content"}).append(o);f.length>=1&&e.append(f);r=r.add(e)}),r}),n("<div>",{"class":"faq-toc"}).append(n("<span>",{"class":"faq-toc-title",text:u.text()})).append(u.siblings(".toc-content"))}):u.find("table.toc").remove(),l=u.find("ul"),l.length===0?(a=function(n){window.location.href=s.options.urlBase+s.options.infoPath+r(n)},u.find("a:not(.faq-toc-link)").replaceWith(function(i,r){var u=n(this),f=t(u.attr("href"));return u.hasClass("image")?n(r).removeAttr("alt"):n.isEmptyObject(f)||f.page===undefined?n("<a>",{href:u.attr("href"),"class":"inline-link",text:r}):n("<a>",{href:"#",html:r}).attr("data-entry",f.page).on("click",function(t){t.preventDefault();t.stopPropagation();var i=n(t.delegateTarget),r=i.data("entry");a(r)})})):(u.find("ul").reverse().replaceWith(function(u,o){var c=n(o),h=n();return c.each(function(u,o){var a=n(o),c=a.children("a:not(.faq-toc-link)"),v=t(c.attr("href")),l;if(c.length===0||v.page===undefined)c.length!==0&&c.removeClass().addClass("inline-link"),h=h.add(n("<ul>").append(a));else{l=n("<h3>",{"class":"ui-accordion-header ui-helper-reset ui-state-default ui-corner-all"}).append(n("<span>",{"class":"ui-icon ui-icon-triangle-1-e"})).append(n("<a>",{href:"#",text:c.text()}).attr("data-entry",r(v.page)));l.on("click",function(t){var r,u,h,o;if(t.preventDefault(),t.stopPropagation(),r=n(t.currentTarget),u=r.find("a[data-entry]").data("entry"),r.hasClass("open")){r.removeClass("open").next().hide();r.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e");return}h=r.closest(".faqAccordion");o=h.add(h.siblings(".faqAccordion")).children(".ui-accordion-header.open");o.removeClass("open");o.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e");o.next(".ui-accordion-content").hide();f||s.options.maxDepth!==-1&&e>=s.options.maxDepth?window.location.href=s.options.urlBase+s.options.infoPath+u:(r.hasClass("fetched")?(s.pushState(u,r.find("a[data-entry]").text()),r.next().show()):(s.pushState(u,r.find("a[data-entry]").text()),s.load(i(u),function(n){var t=s.render(n,!1,e+1,u);r.addClass("fetched").next().empty().append(t)},function(){r.next().html(n("<h3>",{text:"Leider ist ein Fehler aufgetreten."}))}),r.next().show()),r.toggleClass("open"),r.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e"))});l=l.add(n("<div>",{"class":"ui-accordion-content"}));h=h.add(l)}}),h.filter(".ui-accordion-header").length===0?h:n("<div>",{"class":"faqAccordion ui-accordion ui-widget"}).append(h)}),u.find("a:not([data-entry]):not(.external):not(.faq-toc-link)").replaceWith(function(i,u){var f=n(this),e=t(f.attr("href"));return f.hasClass("image")?n(u).removeAttr("alt"):n.isEmptyObject(e)||e.page===undefined?n("<a>",{href:f.attr("href"),"class":"inline-link",text:u}):n("<a>",{href:s.options.urlBase+s.options.infoPath+r(e.page),"class":"inline-link",text:u})})),h=u.children("h1,h2,h3").first(),c="<h3>",e===0&&(c="<h2>"),s.options.showTitle===!0&&h.length===0?(h=n(c,{"class":"headline",text:i(o).replace(/\_/gi," ")}),u.prepend(h)):(h.prependTo(u),h.replaceWith(function(t,i){return n(c,{"class":"headline",html:i})})),u)},renderSearchResults:function(t,r){var u=this;return(r=r!==undefined?r:u.options.searchLimit,t.children().length===0)?n("<h3>",{"class":"pageNotFound",text:"Zu Ihrer Suchanfrage wurden keine Ergebnisse gefunden."}):(t.find("p").slice(0,r).reverse().replaceWith(function(){var r=n(this),f=n(),t=n("<h3>",{"class":"ui-accordion-header ui-helper-reset ui-state-default ui-corner-all"}).append(n("<span>",{"class":"ui-icon ui-icon-triangle-1-e"})).append(n("<a>",{href:"#",text:r.attr("title").trim()}).attr("data-entry",i(r.attr("url").trim())));t.on("click",function(t){t.preventDefault();t.stopPropagation();var i=n(t.currentTarget),r=i.find("a[data-entry]").data("entry");if(i.hasClass("open")){i.next().hide();i.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e");return}i.hasClass("fetched")?(u.pushState(r,i.find("a[data-entry]").text()),i.next().show()):(u.pushState(r,i.find("a[data-entry]").text()),u.load(r,function(n){var t=u.render(n,undefined,undefined,r);i.addClass("fetched").next().empty().append(t)},function(){i.next().html(n("<h3>",{text:"Leider ist ein Fehler aufgetreten."}))}),i.next().show());i.toggleClass("open");i.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e")});return t=t.add(n("<div>",{"class":"ui-accordion-content"})),f.add(t)}),n("<div>",{"class":"faqAccordion ui-accordion ui-widget"}).append(t))},fetch:function(t,i,r,u){var f=this;return n.ajax({url:t,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",cache:!1,data:JSON.stringify({id:encodeURIComponent(i).replace(/\%22/ig,'"')}),success:r,error:function(n){u.call(f,n)},async:!0}),f},search:function(t,i,r){var u=this,f=function(t){var r=n(t.d);i.call(u,r)};return i===undefined&&(i=function(n){var t=u.renderSearchResults(n);u.$el.children(".faqContainer").empty().append(t)}),r===undefined&&(r=function(t){window.console!==undefined&&window.console.error!==undefined&&console.error("Search failed",t);u.$el.children(".faqContainer").empty().append(n("<h3>",{"class":"pageNotFound",text:"Leider ist beim Laden ein Fehler aufgetreten."}))}),this.fetch(this.options.searchUrl,t,f,r)},load:function(t,i,r){var u=this,f=function(r){var f,e,o;if(u.history[t]=r,f=n(r.d).removeAttr("title").removeAttr("onClick"),f.find("p[rating]").remove(),u.options.maxDepth>=0){for(e="ul ",o=0;o<u.options.maxDepth;o++)e+="ul ";f.find(e.trim()).remove()}i.call(u,f)};return i===undefined&&(i=function(n){var i=u.render(n,undefined,undefined,t);u.$el.children(".faqContainer").empty().append(i)}),r===undefined&&(r=function(t){window.console!==undefined&&window.console.error!==undefined&&console.error("Load failed",t);u.$el.children(".faqContainer").empty().append(n("<h3>",{"class":"pageNotFound",text:"Leider ist beim Laden ein Fehler aufgetreten."}))}),u.history[t]!==undefined?(f.call(u,u.history[t]),u):this.fetch(this.options.entryUrl,t,f,r)},pushState:function(n,t){var r=this;r.pageCounter+=1;window.history.pushState({entry:i(n)},t,r.options.urlBase+r.options.infoPath+n)},init:function(){var t=this,u,f,e;t.$el.empty().append(n("<div>",{"class":"faqContainer"}));t.history={};t.pageCounter=0;n(window).on("popstate",function(i){var u=i.originalEvent,e=t.$el.children(".faqContainer").find(".ui-accordion-header"),f;t.pageCounter-=1;u.state===null?(t.pageCounter<0&&window.location.reload(!0),e.next().each(function(t,i){var r=n(i);r.hide();r.prev().find("span.ui-icon").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-e")})):t.history[u.state.entry]!==undefined?(f=t.$el.children(".faqContainer").find('.ui-accordion-header a[data-entry="'+r(u.state.entry)+'"]').parent(),e.next().each(function(t,i){var r=n(i);n.contains(i,f[0])?(r.show(),r.prev().find("span.ui-icon").addClass("ui-icon-triangle-1-s").removeClass("ui-icon-triangle-1-e")):(r.hide(),r.prev().find("span.ui-icon").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-e"))}),f.find("span.ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-e"),f.addClass("open").next().show()):t.load(u.state.entry)});return n("head>base").length===0&&n("head").append(n("<base>",{href:window.location.href,"class":"faqFix"})),t.options.showSearch&&(u=t.options.initEntry===""||t.options.initEntry===null,t.renderSearch(u)),t.options.initEntry&&(f=t.options.initEntry,e=i(f),t.load(e)),t},updateSearchText:function(t){n(".searchArea input").val(t)}},n.fn.extend({reverse:Array.prototype.reverse}),n.fn.extend({faq:function(n){return new u(this,n)}}),n});